import got from 'got';
import http from 'http';
import log from 'loglevel';
import createController from './controller';

export default (functions, port, apiName) => {
  const server = http.createServer();
  const controller = createController(got, functions);
  const endpoints = functions
    .map(({ method, path }) => ({ method: method.toUpperCase(), path: path.full }));

  server.on('request', controller);

  server.listen(port, () => {
    log.info(`Server is running on port ${port}`);
    log.info('The following endpoints are exposed:');
    if (log.getLevel() <= log.levels.INFO) {
      console.table(endpoints);
    }
    const teardownCommand = `sam-proxy teardown ${apiName}`;
    log.info(`For removing all containers generated by this script, run the following command - "${teardownCommand}"`);
  });
};
